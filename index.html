import React, { useState, useEffect } from 'react';
import { Globe, Flame, Check, X, Star, Lock, ChevronLeft, Trophy, XCircle, MessageCircle } from 'lucide-react';

const LANGUAGES = [
  { id: 'es', name: 'Spanish', flag: 'ðŸ‡ªðŸ‡¸' }, { id: 'fr', name: 'French', flag: 'ðŸ‡«ðŸ‡·' },
  { id: 'de', name: 'German', flag: 'ðŸ‡©ðŸ‡ª' }, { id: 'it', name: 'Italian', flag: 'ðŸ‡®ðŸ‡¹' },
  { id: 'pt', name: 'Portuguese', flag: 'ðŸ‡µðŸ‡¹' }, { id: 'ja', name: 'Japanese', flag: 'ðŸ‡¯ðŸ‡µ' },
  { id: 'ko', name: 'Korean', flag: 'ðŸ‡°ðŸ‡·' }, { id: 'zh', name: 'Chinese', flag: 'ðŸ‡¨ðŸ‡³' },
  { id: 'tr', name: 'Turkish', flag: 'ðŸ‡¹ðŸ‡·' }, { id: 'ru', name: 'Russian', flag: 'ðŸ‡·ðŸ‡º' },
  { id: 'ar', name: 'Arabic', flag: 'ðŸ‡¸ðŸ‡¦' }, { id: 'hi', name: 'Hindi', flag: 'ðŸ‡®ðŸ‡³' },
  { id: 'nl', name: 'Dutch', flag: 'ðŸ‡³ðŸ‡±' }, { id: 'sv', name: 'Swedish', flag: 'ðŸ‡¸ðŸ‡ª' },
  { id: 'pl', name: 'Polish', flag: 'ðŸ‡µðŸ‡±' }, { id: 'vi', name: 'Vietnamese', flag: 'ðŸ‡»ðŸ‡³' },
  { id: 'th', name: 'Thai', flag: 'ðŸ‡¹ðŸ‡­' }, { id: 'el', name: 'Greek', flag: 'ðŸ‡¬ðŸ‡·' },
  { id: 'he', name: 'Hebrew', flag: 'ðŸ‡®ðŸ‡±' }, { id: 'id', name: 'Indonesian', flag: 'ðŸ‡®ðŸ‡©' },
  { id: 'uk', name: 'Ukrainian', flag: 'ðŸ‡ºðŸ‡¦' }, { id: 'no', name: 'Norwegian', flag: 'ðŸ‡³ðŸ‡´' },
  { id: 'da', name: 'Danish', flag: 'ðŸ‡©ðŸ‡°' }, { id: 'fi', name: 'Finnish', flag: 'ðŸ‡«ðŸ‡®' },
  { id: 'sw', name: 'Swahili', flag: 'ðŸ‡°ðŸ‡ª' }
];

const DICTIONARY = {
  pronouns: {
    'I': { es: 'Yo', fr: 'Je', de: 'Ich', it: 'Io', ja: 'ç§', zh: 'æˆ‘', nl: 'Ik', sv: 'Jag', pl: 'Ja', vi: 'TÃ´i', th: 'à¸‰à¸±à¸™', el: 'Î•Î³ÏŽ', he: '×× ×™', id: 'Saya', uk: 'Ð¯', no: 'Jeg', da: 'Jeg', fi: 'MinÃ¤', sw: 'Mimi' },
    'You': { es: 'TÃº', fr: 'Tu', de: 'Du', it: 'Tu', ja: 'ã‚ãªãŸ', zh: 'ä½ ', nl: 'Jij', sv: 'Du', pl: 'Ty', vi: 'Báº¡n', th: 'à¸„à¸¸à¸“', el: 'Î•ÏƒÏ', he: '××ª×”', id: 'Kamu', uk: 'Ð¢Ð¸', no: 'Du', da: 'Du', fi: 'SinÃ¤', sw: 'Wewe' },
    'He': { es: 'Ã‰l', fr: 'Il', de: 'Er', it: 'Lui', ja: 'å½¼', zh: 'ä»–', nl: 'Hij', sv: 'Han', pl: 'On', vi: 'Anh áº¥y', th: 'à¹€à¸‚à¸²', el: 'Î‘Ï…Ï„ÏŒÏ‚', he: '×”×•×', id: 'Dia', uk: 'Ð’Ñ–Ð½', no: 'Han', da: 'Han', fi: 'HÃ¤n', sw: 'Yeye' },
    'She': { es: 'Ella', fr: 'Elle', de: 'Sie', it: 'Lei', ja: 'å½¼å¥³', zh: 'å¥¹', nl: 'Zij', sv: 'Hon', pl: 'Ona', vi: 'CÃ´ áº¥y', th: 'à¹€à¸˜à¸­', el: 'Î‘Ï…Ï„Î®', he: '×”×™×', id: 'Dia', uk: 'Ð’Ð¾Ð½Ð°', no: 'Hun', da: 'Hun', fi: 'HÃ¤n', sw: 'Yeye' },
    'We': { es: 'Nosotros', fr: 'Nous', de: 'Wir', it: 'Noi', ja: 'ç§ãŸã¡', zh: 'æˆ‘ä»¬', nl: 'Wij', sv: 'Vi', pl: 'My', vi: 'ChÃºng tÃ´i', th: 'à¸žà¸§à¸à¹€à¸£à¸²', el: 'Î•Î¼ÎµÎ¯Ï‚', he: '×× ×—× ×•', id: 'Kami', uk: 'ÐœÐ¸', no: 'Vi', da: 'Vi', fi: 'Me', sw: 'Sisi' },
    'They': { es: 'Ellos', fr: 'Ils', de: 'Sie', it: 'Loro', ja: 'å½¼ã‚‰', zh: 'ä»–ä»¬', nl: 'Zij', sv: 'De', pl: 'Oni', vi: 'Há»', th: 'à¸žà¸§à¸à¹€à¸‚à¸²', el: 'Î‘Ï…Ï„Î¿Î¯', he: '×”×', id: 'Mereka', uk: 'Ð’Ð¾Ð½Ð¸', no: 'De', da: 'De', fi: 'He', sw: 'Wao' }
  },
  phrases: {
    'Hello': { es: 'Hola', fr: 'Bonjour', de: 'Hallo', it: 'Ciao', ja: 'ã“ã‚“ã«ã¡ã¯', zh: 'ä½ å¥½', nl: 'Hallo', sv: 'Hej', pl: 'CzeÅ›Ä‡', vi: 'Xin chÃ o', th: 'à¸ªà¸§à¸±à¸ªà¸”à¸µ', el: 'Î“ÎµÎ¹Î± ÏƒÎ±Ï‚', he: '×©×œ×•×', id: 'Halo', uk: 'ÐŸÑ€Ð¸Ð²Ñ–Ñ‚', no: 'Hei', da: 'Hej', fi: 'Hei', sw: 'Hujambo' },
    'Good morning': { es: 'Buenos dÃ­as', fr: 'Bonjour', de: 'Guten Morgen', it: 'Buongiorno', ja: 'ãŠã¯ã‚ˆã†', zh: 'æ—©ä¸Šå¥½', nl: 'Goedemorgen', sv: 'God morgon', pl: 'DzieÅ„ dobry', vi: 'ChÃ o buá»•i sÃ¡ng', th: 'à¸­à¸£à¸¸à¸“à¸ªà¸§à¸±à¸ªà¸”à¸´à¹Œ', el: 'ÎšÎ±Î»Î·Î¼Î­ÏÎ±', he: '×‘×•×§×¨ ×˜×•×‘', id: 'Selamat pagi', uk: 'Ð”Ð¾Ð±Ñ€Ð¾Ð³Ð¾ Ñ€Ð°Ð½ÐºÑƒ', no: 'God morgen', da: 'Godmorgen', fi: 'HyvÃ¤Ã¤ huomenta', sw: 'Habari za asubuhi' },
    'Good night': { es: 'Buenas noches', fr: 'Bonne nuit', de: 'Gute Nacht', it: 'Buonanotte', ja: 'ãŠã‚„ã™ã¿', zh: 'æ™šå®‰', nl: 'Goedenacht', sv: 'God natt', pl: 'Dobranoc', vi: 'ChÃºc ngá»§ ngon', th: 'à¸£à¸²à¸•à¸£à¸µà¸ªà¸§à¸±à¸ªà¸”à¸´à¹Œ', el: 'ÎšÎ±Î»Î·Î½ÏÏ‡Ï„Î±', he: '×œ×™×œ×” ×˜×•×‘', id: 'Selamat malam', uk: 'ÐÐ° Ð´Ð¾Ð±Ñ€Ð°Ð½Ñ–Ñ‡', no: 'God natt', da: 'Godnat', fi: 'HyvÃ¤Ã¤ yÃ¶tÃ¤', sw: 'Usiku mwema' },
    'Thank you': { es: 'Gracias', fr: 'Merci', de: 'Danke', it: 'Grazie', ja: 'ã‚ã‚ŠãŒã¨ã†', zh: 'è°¢è°¢', nl: 'Dank je', sv: 'Tack', pl: 'DziÄ™kujÄ™', vi: 'Cáº£m Æ¡n', th: 'à¸‚à¸­à¸šà¸„à¸¸à¸“', el: 'Î•Ï…Ï‡Î±ÏÎ¹ÏƒÏ„ÏŽ', he: '×ª×•×“×”', id: 'Terima kasih', uk: 'Ð”ÑÐºÑƒÑŽ', no: 'Takk', da: 'Tak', fi: 'Kiitos', sw: 'Asante' },
    'How are you?': { es: 'Â¿CÃ³mo estÃ¡s?', fr: 'Comment Ã§a va?', de: 'Wie geht es dir?', it: 'Come stai?', ja: 'å…ƒæ°—ã§ã™ã‹', zh: 'ä½ å¥½å—', nl: 'Hoe gaat het?', sv: 'Hur mÃ¥r du?', pl: 'Jak siÄ™ masz?', vi: 'Báº¡n khá»e khÃ´ng?', th: 'à¸„à¸¸à¸“à¸ªà¸šà¸²à¸¢à¸”à¸µà¹„à¸«à¸¡', el: 'Î ÏŽÏ‚ ÎµÎ¯ÏƒÏ„Îµ;', he: '×ž×” ×©×œ×•×ž×š', id: 'Apa kabar?', uk: 'Ð¯Ðº ÑÐ¿Ñ€Ð°Ð²Ð¸?', no: 'Hvordan gÃ¥r det?', da: 'Hvordan har du det?', fi: 'MitÃ¤ kuuluu?', sw: 'Habari yako?' }
  },
  verbs: {
    'eat': { es: 'como', fr: 'mange', de: 'esse', it: 'mangio', ja: 'é£Ÿã¹ã‚‹', zh: 'åƒ', nl: 'eet', sv: 'Ã¤ter', pl: 'jem', vi: 'Äƒn', th: 'à¸à¸´à¸™', el: 'Ï„ÏÏŽÏ‰', he: '××•×›×œ', id: 'makan', uk: 'Ñ—Ð¼', no: 'spiser', da: 'spiser', fi: 'syÃ¶n', sw: 'kula', thirdPerson: 'eats' },
    'drink': { es: 'bebo', fr: 'bois', de: 'trinke', it: 'bevo', ja: 'é£²ã‚€', zh: 'å–', nl: 'drink', sv: 'dricker', pl: 'pijÄ™', vi: 'uá»‘ng', th: 'à¸”à¸·à¹ˆà¸¡', el: 'Ï€Î¯Î½Ï‰', he: '×©×•×ª×”', id: 'minum', uk: 'Ð¿â€™ÑŽ', no: 'drikker', da: 'drikker', fi: 'juon', sw: 'kunywa', thirdPerson: 'drinks' },
    'want': { es: 'quiero', fr: 'veux', de: 'will', it: 'voglio', ja: 'æ¬²ã—ã„', zh: 'æƒ³', nl: 'wil', sv: 'vill', pl: 'chcÄ™', vi: 'muá»‘n', th: 'à¸•à¹‰à¸­à¸‡à¸à¸²à¸£', el: 'Î¸Î­Î»Ï‰', he: '×¨×•×¦×”', id: 'ingin', uk: 'Ñ…Ð¾Ñ‡Ñƒ', no: 'vil', da: 'vil', fi: 'haluan', sw: 'taka', thirdPerson: 'wants' },
    'see': { es: 'veo', fr: 'vois', de: 'sehe', it: 'vedo', ja: 'è¦‹ã‚‹', zh: 'çœ‹', nl: 'zie', sv: 'ser', pl: 'widzÄ™', vi: 'tháº¥y', th: 'à¹€à¸«à¹‡à¸™', el: 'Î²Î»Î­Ï€Ï‰', he: '×¨×•××”', id: 'melihat', uk: 'Ð±Ð°Ñ‡Ñƒ', no: 'ser', da: 'ser', fi: 'nÃ¤en', sw: 'ona', thirdPerson: 'sees' },
    'run': { es: 'corro', fr: 'cours', de: 'laufe', it: 'corro', ja: 'èµ°ã‚‹', zh: 'è·‘', nl: 'ren', sv: 'springer', pl: 'biegam', vi: 'cháº¡y', th: 'à¸§à¸´à¹ˆà¸‡', el: 'Ï„ÏÎ­Ï‡Ï‰', he: '×¨×¥', id: 'lari', uk: 'Ð±Ñ–Ð¶Ñƒ', no: 'lÃ¸per', da: 'lÃ¸ber', fi: 'juoksen', sw: 'kimbia', thirdPerson: 'runs' },
    'read': { es: 'leo', fr: 'lis', de: 'lese', it: 'leggo', ja: 'èª­ã‚€', zh: 'è¯»', nl: 'lees', sv: 'lÃ¤ser', pl: 'czytam', vi: 'Ä‘á»c', th: 'à¸­à¹ˆà¸²à¸™', el: 'Î´Î¹Î±Î²Î¬Î¶Ï‰', he: '×§×•×¨×', id: 'membaca', uk: 'Ñ‡Ð¸Ñ‚Ð°ÑŽ', no: 'leser', da: 'lÃ¦ser', fi: 'luen', sw: 'soma', thirdPerson: 'reads' },
    'play': { es: 'juego', fr: 'joue', de: 'spiele', it: 'gioco', ja: 'éŠã¶', zh: 'çŽ©', nl: 'speel', sv: 'spelar', pl: 'gram', vi: 'chÆ¡i', th: 'à¹€à¸¥à¹ˆà¸™', el: 'Ï€Î±Î¯Î¶Ï‰', he: '×ž×©×—×§', id: 'main', uk: 'Ð³Ñ€Ð°ÑŽ', no: 'leker', da: 'leger', fi: 'pelaan', sw: 'cheza', thirdPerson: 'plays' }
  },
  nouns: {
    'bread': { es: 'pan', fr: 'pain', de: 'Brot', it: 'pane', ja: 'ãƒ‘ãƒ³', zh: 'é¢åŒ…', nl: 'brood', sv: 'brÃ¶d', pl: 'chleb', vi: 'bÃ¡nh mÃ¬', th: 'à¸‚à¸™à¸¡à¸›à¸±à¸‡', el: 'ÏˆÏ‰Î¼Î¯', he: '×œ×—×', id: 'roti', uk: 'Ñ…Ð»Ñ–Ð±', no: 'brÃ¸d', da: 'brÃ¸d', fi: 'leipÃ¤', sw: 'mkate', article: '' },
    'water': { es: 'agua', fr: 'eau', de: 'Wasser', it: 'acqua', ja: 'æ°´', zh: 'æ°´', nl: 'water', sv: 'vatten', pl: 'woda', vi: 'nÆ°á»›c', th: 'à¸™à¹‰à¸³', el: 'Î½ÎµÏÏŒ', he: '×ž×™×', id: 'air', uk: 'Ð²Ð¾Ð´Ð°', no: 'vann', da: 'vand', fi: 'vesi', sw: 'maji', article: '' },
    'book': { es: 'libro', fr: 'livre', de: 'Buch', it: 'libro', ja: 'æœ¬', zh: 'ä¹¦', nl: 'boek', sv: 'bok', pl: 'ksiÄ…Å¼ka', vi: 'sÃ¡ch', th: 'à¸«à¸™à¸±à¸‡à¸ªà¸·à¸­', el: 'Î²Î¹Î²Î»Î¯Î¿', he: '×¡×¤×¨', id: 'buku', uk: 'ÐºÐ½Ð¸Ð³Ð°', no: 'bok', da: 'bog', fi: 'kirja', sw: 'kitabu', article: 'a' },
    'cat': { es: 'gato', fr: 'chat', de: 'Katze', it: 'gatto', ja: 'çŒ«', zh: 'çŒ«', nl: 'kat', sv: 'katt', pl: 'kot', vi: 'con mÃ¨o', th: 'à¹à¸¡à¸§', el: 'Î³Î¬Ï„Î±', he: '×—×ª×•×œ', id: 'kucing', uk: 'ÐºÑ–Ñ‚', no: 'katt', da: 'kat', fi: 'kissa', sw: 'paka', article: 'the' },
    'dog': { es: 'perro', fr: 'chien', de: 'Hund', it: 'cane', ja: 'çŠ¬', zh: 'ç‹—', nl: 'hond', sv: 'hund', pl: 'pies', vi: 'con chÃ³', th: 'à¸ªà¸¸à¸™à¸±à¸‚', el: 'ÏƒÎºÏÎ»Î¿Ï‚', he: '×›×œ×‘', id: 'anjing', uk: 'ÑÐ¾Ð±Ð°ÐºÐ°', no: 'hund', da: 'hund', fi: 'koira', sw: 'mbwa', article: 'the' },
    'sun': { es: 'sol', fr: 'soleil', de: 'Sonne', it: 'sole', ja: 'å¤ªé™½', zh: 'å¤ªé˜³', nl: 'zon', sv: 'sol', pl: 'sÅ‚oÅ„ce', vi: 'máº·t trá»i', th: 'à¸”à¸§à¸‡à¸­à¸²à¸—à¸´à¸•à¸¢à¹Œ', el: 'Î®Î»Î¹Î¿Ï‚', he: '×©×ž×©', id: 'matahari', uk: 'ÑÐ¾Ð½Ñ†Ðµ', no: 'sol', da: 'sol', fi: 'aurinko', sw: 'jua', article: 'the' },
    'moon': { es: 'luna', fr: 'lune', de: 'Mond', it: 'luna', ja: 'æœˆ', zh: 'æœˆäº®', nl: 'maan', sv: 'mÃ¥ne', pl: 'ksiÄ™Å¼yc', vi: 'máº·t trÄƒng', th: 'à¸”à¸§à¸‡à¸ˆà¸±à¸™à¸—à¸£à¹Œ', el: 'Ï†ÎµÎ³Î³Î¬ÏÎ¹', he: '×™×¨×—', id: 'bulan', uk: 'Ð¼Ñ–ÑÑÑ†ÑŒ', no: 'mÃ¥ne', da: 'mÃ¥ne', fi: 'kuu', sw: 'mwezi', article: 'the' },
    'home': { es: 'casa', fr: 'maison', de: 'Hause', it: 'casa', ja: 'å®¶', zh: 'å®¶', nl: 'huis', sv: 'hem', pl: 'dom', vi: 'nhÃ ', th: 'à¸šà¹‰à¸²à¸™', el: 'ÏƒÏ€Î¯Ï„Î¹', he: '×‘×™×ª', id: 'rumah', uk: 'Ð´Ñ–Ð¼', no: 'hjem', da: 'hjem', fi: 'koti', sw: 'nyumbani', article: '' }
  }
};

// Generate 15 Lessons
const UNIT_LESSONS = [
  { id: 0, title: "Greetings", type: 'vocabulary', cat: 'phrases' },
  { id: 1, title: "Pronouns 1", type: 'vocabulary', cat: 'pronouns' },
  { id: 2, title: "Common Nouns", type: 'vocabulary', cat: 'nouns' },
  { id: 3, title: "Introduction", type: 'sentence' },
  { id: 4, title: "Action Verbs", type: 'vocabulary', cat: 'verbs' },
  { id: 5, title: "Simple Phrases", type: 'sentence' },
  { id: 6, title: "Polite Words", type: 'vocabulary', cat: 'phrases' },
  { id: 7, title: "Food & Water", type: 'vocabulary', cat: 'nouns' },
  { id: 8, title: "Nature", type: 'vocabulary', cat: 'nouns' },
  { id: 9, title: "Daily Actions", type: 'vocabulary', cat: 'verbs' },
  { id: 10, title: "Big Review", type: 'sentence' },
  { id: 11, title: "Animals", type: 'vocabulary', cat: 'nouns' },
  { id: 12, title: "More Verbs", type: 'vocabulary', cat: 'verbs' },
  { id: 13, title: "Sentence Mix", type: 'sentence' },
  { id: 14, title: "Final Quiz", type: 'sentence' }
];

export default function App() {
  const [view, setView] = useState('landing');
  const [selectedLang, setSelectedLang] = useState(null);
  const [progress, setProgress] = useState(() => JSON.parse(localStorage.getItem('lingo_progress_v25') || '{}'));
  const [currentTasks, setCurrentTasks] = useState([]);
  const [taskIdx, setTaskIdx] = useState(0);
  const [selection, setSelection] = useState(null);
  const [reorderList, setReorderList] = useState([]);
  const [feedback, setFeedback] = useState(null);

  useEffect(() => {
    localStorage.setItem('lingo_progress_v25', JSON.stringify(progress));
  }, [progress]);

  const shuffle = (arr) => [...arr].sort(() => Math.random() - 0.5);

  const getTranslation = (cat, key, langId) => {
    const entry = DICTIONARY[cat]?.[key];
    if (!entry) return key;
    return entry[langId] || entry['es'] || key;
  };

  const generateLesson = (lang, lesson) => {
    const tasks = [];
    const lId = lang.id;
    const allVerbs = Object.keys(DICTIONARY.verbs);
    const allNouns = Object.keys(DICTIONARY.nouns);
    const allPronouns = Object.keys(DICTIONARY.pronouns);
    const allPhrases = Object.keys(DICTIONARY.phrases);

    const addWordTask = (cat, key) => {
      const correct = getTranslation(cat, key, lId);
      const distractors = shuffle(Object.keys(DICTIONARY[cat]))
        .filter(k => k !== key)
        .map(k => getTranslation(cat, k, lId));
      
      const options = shuffle([correct, ...distractors.slice(0, 3)]);
      tasks.push({ type: 'tap', prompt: `Translate: "${key}"`, answer: correct, options });
    };

    if (lesson.type === 'vocabulary') {
      const keys = shuffle(Object.keys(DICTIONARY[lesson.cat])).slice(0, 5);
      keys.forEach(k => addWordTask(lesson.cat, k));
    } else {
      for (let i = 0; i < 5; i++) {
        // Occasionally mix in a phrase
        if (Math.random() > 0.7) {
          const phrase = shuffle(allPhrases)[0];
          const target = getTranslation('phrases', phrase, lId);
          tasks.push({
            type: 'tap',
            prompt: `Translate: "${phrase}"`,
            answer: target,
            options: shuffle([target, ...shuffle(allPhrases).filter(p => p !== phrase).slice(0, 3).map(p => getTranslation('phrases', p, lId))])
          });
        } else {
          const p = shuffle(allPronouns)[0];
          const v = shuffle(allVerbs)[0];
          const n = shuffle(allNouns)[0];

          const verbDisplay = (p === 'He' || p === 'She') ? DICTIONARY.verbs[v].thirdPerson : v;
          const nounArticle = DICTIONARY.nouns[n].article;
          const englishPrompt = `${p} ${verbDisplay} ${nounArticle ? nounArticle + ' ' : ''}${n}`;

          const targetArr = [getTranslation('pronouns', p, lId), getTranslation('verbs', v, lId), getTranslation('nouns', n, lId)];
          const bankFillers = shuffle([...allPronouns, ...allVerbs, ...allNouns])
            .map(k => {
              if (DICTIONARY.pronouns[k]) return getTranslation('pronouns', k, lId);
              if (DICTIONARY.verbs[k]) return getTranslation('verbs', k, lId);
              return getTranslation('nouns', k, lId);
            })
            .filter(val => !targetArr.includes(val));

          tasks.push({
            type: 'reorder',
            prompt: `Translate: "${englishPrompt}"`,
            answer: targetArr,
            options: shuffle([...targetArr, ...bankFillers.slice(0, 4)])
          });
        }
      }
    }
    return tasks;
  };

  const startLesson = (lesson) => {
    setCurrentTasks(generateLesson(selectedLang, lesson));
    setTaskIdx(0);
    setFeedback(null);
    setSelection(null);
    setReorderList([]);
    setView('lesson');
  };

  const handleCheck = () => {
    const task = currentTasks[taskIdx];
    const isCorrect = task.type === 'tap' 
      ? selection === task.answer 
      : JSON.stringify(reorderList) === JSON.stringify(task.answer);
    setFeedback(isCorrect ? 'correct' : 'wrong');
  };

  const handleNext = () => {
    if (taskIdx + 1 < currentTasks.length) {
      setTaskIdx(taskIdx + 1);
      setFeedback(null);
      setSelection(null);
      setReorderList([]);
    } else {
      const currentLevel = progress[selectedLang.id] || 0;
      setProgress({ ...progress, [selectedLang.id]: currentLevel + 1 });
      setView('curriculum');
    }
  };

  if (view === 'landing') {
    return (
      <div className="min-h-screen bg-white p-8 flex flex-col items-center overflow-y-auto">
        <header className="text-center mb-12">
          <div className="w-20 h-20 bg-green-500 rounded-3xl flex items-center justify-center mx-auto mb-4 shadow-xl">
            <Globe className="text-white w-10 h-10" />
          </div>
          <h1 className="text-4xl font-black text-slate-800 tracking-tight">LingoDash Pro</h1>
          <p className="text-slate-400 font-bold uppercase text-xs mt-2">World Mastery Edition</p>
        </header>
        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 w-full max-w-6xl pb-10">
          {LANGUAGES.map(l => (
            <button key={l.id} onClick={() => { setSelectedLang(l); setView('curriculum'); }} className="p-4 border-4 border-slate-100 rounded-[2rem] hover:bg-indigo-50 hover:border-indigo-200 transition-all active:scale-95 shadow-sm text-center">
              <span className="text-4xl block mb-2">{l.flag}</span>
              <span className="font-black text-slate-700 text-sm">{l.name}</span>
            </button>
          ))}
        </div>
      </div>
    );
  }

  if (view === 'curriculum') {
    const userLevel = progress[selectedLang.id] || 0;
    return (
      <div className="min-h-screen bg-slate-50 flex flex-col">
        <nav className="bg-white p-4 border-b flex items-center justify-between sticky top-0 z-10 shadow-sm">
          <button onClick={() => setView('landing')} className="p-2 hover:bg-slate-100 rounded-full"><ChevronLeft /></button>
          <div className="font-black text-lg flex items-center gap-2">{selectedLang.flag} {selectedLang.name}</div>
          <div className="w-10" />
        </nav>
        <main className="max-w-xl mx-auto w-full p-6 space-y-8 pb-32">
          <div className="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-[2.5rem] p-8 text-white shadow-xl relative overflow-hidden">
            <h2 className="text-3xl font-black italic">Unit 1</h2>
            <p className="font-bold opacity-80 uppercase text-sm tracking-widest">Foundations</p>
            <Trophy className="absolute -right-4 -bottom-4 w-32 h-32 opacity-20 rotate-12" />
          </div>
          <div className="flex flex-col items-center gap-10">
            {UNIT_LESSONS.map((item, i) => {
              const isLocked = i > userLevel;
              const isDone = i < userLevel;
              return (
                <div key={item.id} className="flex flex-col items-center w-full relative">
                  {i < UNIT_LESSONS.length - 1 && (
                    <div className={`absolute h-10 w-2 top-20 ${isDone ? 'bg-yellow-400' : 'bg-slate-200'}`} />
                  )}
                  <button 
                    disabled={isLocked}
                    onClick={() => startLesson(item)}
                    className={`w-20 h-20 rounded-full flex items-center justify-center shadow-lg transition-all relative z-10 ${isLocked ? 'bg-slate-200 text-slate-400' : isDone ? 'bg-yellow-400 border-b-8 border-yellow-600' : 'bg-green-500 border-b-8 border-green-700 active:border-b-0 active:translate-y-1'}`}
                  >
                    {isLocked ? <Lock /> : isDone ? <Check size={32} className="text-white" /> : <Star size={32} className="text-white fill-white" />}
                  </button>
                  <span className={`mt-3 font-black uppercase text-[10px] tracking-[0.2em] ${isLocked ? 'text-slate-300' : 'text-slate-500'}`}>
                    {item.title}
                  </span>
                </div>
              );
            })}
          </div>
        </main>
      </div>
    );
  }

  const task = currentTasks[taskIdx];
  const progressPercent = (taskIdx / currentTasks.length) * 100;

  return (
    <div className="h-screen bg-white flex flex-col overflow-hidden">
      <div className="p-6 flex items-center gap-4">
        <XCircle onClick={() => setView('curriculum')} className="text-slate-300 cursor-pointer hover:text-slate-500" />
        <div className="flex-1 h-3 bg-slate-100 rounded-full overflow-hidden">
          <div className="bg-green-500 h-full transition-all duration-500" style={{ width: `${progressPercent}%` }} />
        </div>
      </div>

      <div className="flex-1 overflow-y-auto px-6 pb-44">
        <div className="max-w-xl mx-auto py-6">
          <div className="flex gap-4 mb-10 items-start">
            <div className="text-5xl drop-shadow-md">ðŸ¦‰</div>
            <div className="border-4 border-slate-100 p-6 rounded-[2.5rem] bg-white relative flex-1 shadow-sm">
              <p className="text-xl font-black text-slate-800 leading-tight flex items-center gap-2">
                {task.type === 'tap' ? <MessageCircle size={20} className="text-indigo-400" /> : null}
                {task.prompt}
              </p>
            </div>
          </div>

          {task.type === 'tap' ? (
            <div className="grid gap-3">
              {task.options.map((opt, i) => (
                <button 
                  key={i} 
                  disabled={feedback}
                  onClick={() => setSelection(opt)}
                  className={`p-5 text-left border-2 border-b-4 rounded-3xl font-black text-lg transition-all ${selection === opt ? 'bg-indigo-50 border-indigo-400 text-indigo-700' : 'border-slate-100 hover:bg-slate-50 text-slate-700'}`}
                >
                  <span className="text-slate-300 mr-3 text-sm">{i + 1}</span> {opt}
                </button>
              ))}
            </div>
          ) : (
            <div className="space-y-8">
              <div className="min-h-[160px] border-b-4 border-dashed border-slate-100 p-4 flex flex-wrap gap-2 items-start bg-slate-50/30 rounded-[2.5rem]">
                {reorderList.map((w, i) => (
                  <button key={i} disabled={feedback} onClick={() => setReorderList(reorderList.filter((_, idx) => idx !== i))} className="p-3 px-6 bg-white border-2 border-b-4 border-slate-200 rounded-2xl font-black shadow-md">
                    {w}
                  </button>
                ))}
              </div>
              <div className="flex flex-wrap gap-3 justify-center">
                {task.options.map((opt, i) => (
                  <button 
                    key={i} 
                    disabled={reorderList.includes(opt) || feedback}
                    onClick={() => setReorderList([...reorderList, opt])}
                    className={`p-3 px-6 border-2 border-b-4 rounded-2xl font-black transition-all ${reorderList.includes(opt) ? 'bg-slate-100 border-slate-100 text-transparent' : 'bg-white border-slate-200 hover:border-slate-400 active:translate-y-1 active:border-b-0'}`}
                  >
                    {opt}
                  </button>
                ))}
              </div>
            </div>
          )}
        </div>
      </div>

      <footer className={`fixed bottom-0 left-0 right-0 p-8 pt-4 border-t-4 transition-all z-50 ${feedback === 'correct' ? 'bg-green-100 border-green-200' : feedback === 'wrong' ? 'bg-red-100 border-red-200' : 'bg-white'}`}>
        <div className="max-w-xl mx-auto">
          {feedback && (
            <div className="mb-4 flex items-center gap-4">
              <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-white ${feedback === 'correct' ? 'bg-green-500' : 'bg-red-500'}`}>
                {feedback === 'correct' ? <Check size={32} /> : <X size={32} />}
              </div>
              <div>
                <p className={`text-xl font-black ${feedback === 'correct' ? 'text-green-800' : 'text-red-800'}`}>
                  {feedback === 'correct' ? 'Excellent!' : 'Not quite right!'}
                </p>
                {feedback === 'wrong' && (
                   <p className="text-red-600 font-bold text-sm">Correct answer: {Array.isArray(task.answer) ? task.answer.join(' ') : task.answer}</p>
                )}
              </div>
            </div>
          )}
          <button 
            onClick={feedback ? handleNext : handleCheck}
            disabled={!feedback && !selection && reorderList.length === 0}
            className={`w-full py-5 rounded-3xl font-black text-xl shadow-xl transition-all active:scale-[0.98] ${feedback ? (feedback === 'correct' ? 'bg-green-500 text-white' : 'bg-red-500 text-white') : (!selection && reorderList.length === 0 ? 'bg-slate-200 text-slate-400' : 'bg-green-500 text-white shadow-green-200')}`}
          >
            {feedback ? 'CONTINUE' : 'CHECK'}
          </button>
        </div>
      </footer>
    </div>
  );
}
